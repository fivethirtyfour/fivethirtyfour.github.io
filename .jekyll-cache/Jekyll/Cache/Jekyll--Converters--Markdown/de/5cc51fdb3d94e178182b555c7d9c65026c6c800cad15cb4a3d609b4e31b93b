I"ç1<h1 id="matomo--azure--">Matomo + Azure = üìà</h1>

<h1 id="what-is-matomo">What is Matomo?</h1>

<p><a href="https://matomo.org">Matomo</a> is an all-in-one premium web analytics platform with the philosophy of 100% data ownership. Simply stated, you own your data, no one else. That means that no abuse of privacy via Google Analytics, Facebook analytics or any other third-party website analytics software.</p>

<p>Privacy has been a growing concern of mine and I‚Äôm starting, bit by bit, to take back some control of that and protect my end users from similar abuses. Be the change you want to see, so the saying goes.</p>

<h1 id="what-youll-need">What you‚Äôll need</h1>

<p>Just like previous articles I‚Äôm an Azure user. Azure is great, it‚Äôs friendly to use, simple, cost effective, and just good. That‚Äôs what we‚Äôll be using.</p>

<p>Listed below are what we will need for required installation and configuration.</p>

<ul>
  <li>An account on Azure</li>
  <li>Access to SSH to configure our virtual machine which will be Linux based (WSL, Linux, macOS, etc)</li>
</ul>

<h1 id="getting-started">Getting started</h1>

<h2 id="pre-requisites">Pre-requisites</h2>

<h3 id="creating-the-virtual-machine">Creating the virtual machine</h3>

<p>Using the free account and credits for Azure we will leverage some of the other free marketplace Azure services.</p>

<p>Log into your newly created or existing Azure account and do a search for <code class="language-plaintext highlighter-rouge">Free services</code></p>

<p><img src="/assets/images/post-images/matomo-analytics-azure/free-services-image.png" alt="Azure Free Services" /></p>

<p>Select <code class="language-plaintext highlighter-rouge">Free services</code> and you‚Äôll be presented with a list of available free services. We‚Äôre going to select the <strong>Linux Virtual Machine</strong>, this gives us 750 hours of free B1S this should provide us with some solid, cheap hours of use. Even after the free 750 hours credit it still would only cost, roughly, $8/mo. Pretty cheap, relatively speaking.</p>

<p><img src="/assets/images/post-images/matomo-analytics-azure/free-services-linux-vm.png" alt="Azure B1S Free Linux" /></p>

<p>We need to configure our virtual machine, like so. Obviously fill in your own unique information. If you plan on accessing your VM from more than one computer that you select <code class="language-plaintext highlighter-rouge">Password</code> instead of <code class="language-plaintext highlighter-rouge">SSH public key</code> it‚Äôs a bit less mucking about.</p>

<p><img src="/assets/images/post-images/matomo-analytics-azure/create-virtual-machine.png" alt="Azure create virtual machine" /></p>

<p>If everything was configured properly we should have passed validation, if you didn‚Äôt fix your errors and try again. Then click <code class="language-plaintext highlighter-rouge">Create</code> to start creating your virtual machine.</p>

<p>Navigate to your VM and check what the <code class="language-plaintext highlighter-rouge">Public IP Address</code> is and then we will use that to ssh into our VM.</p>

<h3 id="configuring-the-virtual-machine">Configuring the Virtual Machine</h3>

<p>SSH into your virtual machine by typing <code class="language-plaintext highlighter-rouge">ssh [username]@[public IP address]</code>, replacing <code class="language-plaintext highlighter-rouge">[username]</code> with the username you specified in the creation of the virtual machine and then replacing <code class="language-plaintext highlighter-rouge">[public IP address]</code> with the public IP address of your virtual machine.</p>

<p>Once we‚Äôre logged in update the virtual machine by running the following commands.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt install php7.3 php7.3-cli php7.3-fpm php7.3-curl php7.3-gd mysql-server php7.3-mysql php-xml php7.3-mbstring unzip -y
sudo apt update
sudo apt upgrade -y
</code></pre></div></div>

<p>Now that we‚Äôre updated to the latest version(s) of our virtual machines software we can continue onto the install.</p>

<h3 id="creating-a-database">Creating a database</h3>

<p>Before we can run Matomo we will need to create a database for Matomo to use. Let‚Äôs sign into our MySQL as our root user.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql -u root -p
</code></pre></div></div>

<p>Create the database.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE DATABASE matomo;
</code></pre></div></div>

<p>Create a new user for the new database.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE USER `billybob@example.com` IDENTIFIED BY 'your_secret_password';
</code></pre></div></div>

<p>Grant new user the relevant permissions on the database.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GRANT ALL ON matomo.* TO `billybob@example.com`;
</code></pre></div></div>

<p>Flush privileges and exit the MySQL console.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FLUSH PRIVILEGES;
exit
</code></pre></div></div>

<h2 id="installing-matomo">Installing Matomo</h2>

<h3 id="installing-nginx-and-configure-nginx-for-matomo">Installing Nginx and configure Nginx for Matomo</h3>

<p>Matomo will need some sort of web server software so that we can operate Matomo as intended. For the purpose of this tutorial we‚Äôre going to instal Nginx.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt install -y nginx
</code></pre></div></div>

<p>Now that we‚Äôve got Nginx installed we need to configure Nginx for our Matomo instance. First we‚Äôll need to create the file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nano /etc/nginx/sites-available/matomo.conf
</code></pre></div></div>

<p>Now we will need to populate the file with our server configurations. Obviously change the <code class="language-plaintext highlighter-rouge">server_name</code> with your specific server name.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {

  listen [::]:443 ssl http2;
  listen 443 ssl http2;
  listen [::]:80;
  listen 80;

  server_name stats.fivethirtyfour.com;
  root /var/www/matomo/;
  index index.php;

  location ~ ^/(index|matomo|piwik|js/index).php {
    include snippets/fastcgi-php.conf;
    fastcgi_param HTTP_PROXY ""; 
    fastcgi_pass unix:/var/run/php/php7.3-fpm.sock; 
  }
  
  location = /plugins/HeatmapSessionRecording/configs.php {
    include snippets/fastcgi-php.conf;
    fastcgi_param HTTP_PROXY "";
    fastcgi_pass unix:/var/run/php/php7.3-fpm.sock;
  }

  location ~* ^.+\.php$ {
    deny all;
    return 403;
  }

  location / {
    try_files $uri $uri/ =404;
  }
  
  location ~ /(config|tmp|core|lang) {
    deny all;
    return 403;
  }

  location ~ \.(gif|ico|jpg|png|svg|js|css|htm|html|mp3|mp4|wav|ogg|avi|ttf|eot|woff|woff2|json)$ {
    allow all;
  }

  location ~ /(libs|vendor|plugins|misc/user) {
    deny all;
    return 403;
  }

}
</code></pre></div></div>

<p>Now we will need to activate the new matomo.conf configuration by linking the file to the <code class="language-plaintext highlighter-rouge">sites-enabled</code> directory.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo ln -s /etc/nginx/sites-available/matomo.conf /etc/nginx/sites-enabled
</code></pre></div></div>

<p>Test the Nginx configuration for syntax errors.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nginx -t
</code></pre></div></div>

<p>Reload the Nginx service</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo systemctl reload nginx.service
</code></pre></div></div>

<h3 id="download--extract-matomo">Download &amp; Extract Matomo</h3>

<p>Before we download and install Matomo we need to create and move into our webserver‚Äôs directory.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo mkdir -p /var/wwww/ &amp;&amp; cd /var/www/
</code></pre></div></div>

<p>Now we need to download Matomo first before we can install it. From our console run the following commands. The first section is downloading the file, the second section is unzipping our file we just downloaded and the third section is to clean up the .zip file we downloaded.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://builds.matomo.org/matomo.zip &amp;&amp; unzip matomo.zip &amp;&amp; rm matomo.zip
</code></pre></div></div>

<p>Finally let‚Äôs change ownership of the <code class="language-plaintext highlighter-rouge">/var/www/matomo</code> directory to <code class="language-plaintext highlighter-rouge">www-data user</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo chown -R www-data:www-data /var/www/matomo
</code></pre></div></div>

<h3 id="installing-a-lets-encrypt-certificate-for-ssl">Installing a Let‚Äôs Encrypt certificate for ssl</h3>

<p>It‚Äôs important to run our services and websites over SSL. Not only does it give us our privacy but it provides the confidence and privacy of our users.</p>

<p>First we need to install the required repositories to run LetsEncrypt</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo add-apt-repository ppa:certbot/certbot
sudo apt update
sudo apt upgrade -y
sudo apt install certbot python-certbot-nginx -y
</code></pre></div></div>

<p>Now that the software is installed we need to create our certificate using the Nginx certbot plugin. Obviously changing the domain for what your site will be.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo certbot --nginx -d stats.fivethirtyfour.com
</code></pre></div></div>

<p>Now if we look at our <code class="language-plaintext highlighter-rouge">/etc/nginx/sites-available/matomo.conf</code> file we should see that certbot has added our SSL configurations for us.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>######################################
## SNIPPET OF THE MATOMO.CONF FILE  ##
######################################

ssl_certificate /etc/letsencrypt/live/stats.fivethirtyfour.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/stats.fivethirtyfour.com/privkey.pem; # managed by Certbot
}

server {
    if ($host = stats.fivethirtyfour.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

  listen [::]:80;
  listen 80;
  server_name stats.fivethirtyfour.com;
    return 404; # managed by Certbot
}
</code></pre></div></div>

<p>Now head over to your website where you deployed your site and you should see the Matomo installation page.</p>

<p><img src="/assets/images/post-images/matomo-analytics-azure/matomo-setup-installation.png" alt="Matomo installation setup page" /></p>

<h3 id="completing-the-matomo-analytics-setup">Completing the Matomo Analytics setup</h3>

<p>Now go through the Matomo installation process and once you get to the <code class="language-plaintext highlighter-rouge">Database Setup</code> section make sure to file this in with the information you created in the <code class="language-plaintext highlighter-rouge">Creating a database</code> section earlier in this guide.</p>

<p><img src="/assets/images/post-images/matomo-analytics-azure/matomo-database-setup.png" alt="Matomo database setup" /></p>

<p>Continue going through the configuration and once you get to the <code class="language-plaintext highlighter-rouge">Tracking code</code> section make sure you copy your tracking code snippet. This is what you will use to add to your website to gather the analytics information.</p>

<h2 id="congratulations-you-now-have-matomo-analytics-running-in-azure-cloud-instance">Congratulations you now have Matomo Analytics running in Azure cloud instance!!!</h2>

<p><img src="https://media.giphy.com/media/YnSTMd4T9BISZcHcAL/giphy.gif" alt="Congratulations GIF" /></p>
:ET